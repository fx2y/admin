clear
cd ~/workspace-demo/go-sample-app
@_ECHO_ON

kns argocd
k get all
k api-resources --api-group argoproj.io
k get apps,appprojs
k port-forward svc/argocd-server 8080:80 2>&1 > /dev/null &
k get pods
argocd login localhost:8080 --insecure --username admin

# GENERAL
# Application Name: dev-go-sample-app
# Project: default
# SOURCE
# Repository URL: https://github.com/<GITHUB_NS>/go-sample-app.git
# Revision: HEAD
# Path: ops/overlays/dev
# DESTINATION
# Cluster: https://kubernetes.default.svc
# Namespace: dev

## Sync and review the application

## Explore the deployment

kns dev
k get all
k get endpoints
k port-forward svc/go-sample-app 8081:8080 2>&1 > /dev/null &
curl localhost:8081
ps
kill

argocd app set dev-go-sample-app --sync-policy automated
cd ops/overlays/dev
sed -i '' 's|1.0.1|1.0.0|g' kustomization.yaml

git commit -am "Switched back to 1.0.0"
git push origin master
k get pods
k port-forward svc/go-sample-app 8081:8080 &
curl localhost:8081
ps
kill

#echo "namePrefix: dev-" >> kustomization.yaml
yq w -i kustomization.yaml namePrefix dev-
git commit -am 'Add prefix dev-'
git push origin master
argocd app list
argocd app get dev-go-sample-app
# Hit Prune Sync in UI
argocd app get dev-go-sample-app

cd ../../../cicd
cp -r $DEMO/gitops/cicd/argo argo
tree .
cd argo

yqc argo-deploy-dev.yaml
yqc argo-deploy-prod.yaml

kns argocd
k apply -f argo-deploy-prod.yaml
kns prod
k get rs
k port-forward svc/prod-go-sample-app 8081:8080 2>&1 > /dev/null &
curl localhost:8081
ps
kill
