@_ECHO_ON

kns argocd
k get all
k api-resources --api-group argoproj.io
k get apps,appprojs
k port-forward svc/argocd-server 8080:80 2>&1 > /dev/null &
k get pods
argocd login localhost:8080 --insecure --username admin

git add -A
git commit -m "Initial commit"
git push

# GENERAL
# Application Name: go-sample-app-dev
# Project: default
# SOURCE
# Repository URL: https://github.com/<GITHUB_NS>/go-sample-app.git
# Revision: HEAD
# Path: ops/overlays/dev
# DESTINATION
# Cluster: https://kubernetes.default.svc
# Namespace: dev

## Sync and review the application

## Explore the deployment

kns dev
k get all
k get endpoints
k get endpointslice
k port-forward service/go-sample-app 8081:8080 &
curl localhost:8081
kill

argocd app set go-sample-app-dev --sync-policy automated
cd ../../ops/overlays/dev
yq m -i -x kustomization.yaml - <<EOF
images:
- name: ${IMG_NS}/go-sample-app  # used for Kustomize matching
newTag: 1.0.0
EOF

git commit -am "Switched back to 1.0.0"
git push
k rollout status deploy/go-sample-app
k port-forward svc/go-sample-app 8081:8080 &
curl localhost:8081
kill

#echo "namePrefix: dev-" >> kustomization.yaml
yq w -i kustomization.yaml namePrefix dev-
git commit -am 'Add prefix dev-'
git push origin master
argocd app list
argocd app get go-sample-app-dev
# Hit Prune Sync in UI
argocd app get go-sample-app-dev

cd ../../../cicd
cp -r $DEMO/argocd/cicd/argo argo
tree .
cd argon

yqc argo-deploy-dev.yaml
yqc argo-deploy-prod.yaml

kns argocd
k apply -f argo-deploy-prod.yaml
kns prod
k rollout status deploy/prod-go-sample-app
k port-forward service/prod-go-sample-app 8081:8080 &
curl localhost:8081
k get pods
k logs
kill

argocd app set go-sample-app-prod --self-heal
k delete deploy prod-go-sample-app
