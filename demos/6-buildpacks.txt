@_ECHO_ON

# Provide your GitHub and Docker Hub namespace
GITHUB_NS=
IMG_NS=
kubectl create ns dev
kubectl create ns prod
git clone https://github.com/$GITHUB_NS/go-sample-app.git
git clone https://github.com/$GITHUB_NS/go-sample-app-ops.git
hub clone https://github.com/springone-tour-2020-cicd/go-sample-app.git && cd go-sample-app
hub fork --remote-name origin
git ls-remote --heads | grep scenario
# Fill this in with the branch name (e.g. BRANCH=scenario-1-finished)
BRANCH=
git checkout --track origin/$BRANCH
find . -name *.yaml -exec sed -i "s//springone-tour-2020-cicd//${GITHUB_NS}/g" {} +
find . -name *.yaml -exec sed -i "s/ springone-tour-2020-cicd/ ${IMG_NS}/g" {} +
git add -A
git commit -m "Reset from branch $BRANCH, updated namespaces"
git branch -m master old-master
git branch -m $BRANCH master
git push -f -u origin master
git push -f origin old-master
git branch -d old-master
hub clone https://github.com/springone-tour-2020-cicd/go-sample-app-ops.git && cd go-sample-app-ops
hub fork --remote-name origin
git checkout --track origin/$BRANCH
find . -name *.yaml -exec sed -i "s//springone-tour-2020-cicd//${GITHUB_NS}/g" {} +
find . -name *.yaml -exec sed -i "s/ springone-tour-2020-cicd/ ${IMG_NS}/g" {} +
git add -A
git commit -m "Reset from branch $BRANCH, updated namespaces"
git branch -m master old-master
git branch -m $BRANCH master
git push -f -u origin master
git push -f origin old-master
git branch -d old-master
# Fill this in with your GitHub login
GITHUB_USER=
GITHUB_USER=$GITHUB_NS
# Fill this in with your GitHub access token
GITHUB_TOKEN=
kubectl create secret generic github-token --from-literal=GITHUB_TOKEN=${GITHUB_TOKEN}
cd go-sample-app
cat Dockerfile
pack build go-sample-app --builder gcr.io/paketo-buildpacks/builder:base-platform-api-0.3
docker images | grep go-sample-app
docker login -u ${IMG_NS}
pack set-default-builder gcr.io/paketo-buildpacks/builder:base-platform-api-0.3
pack build $IMG_NS/go-sample-app --publish
cd ../go-sample-app-ops
cd cicd/tekton
yq d -i build-pipeline.yaml "spec.tasks.(name==verify-digest)"
yq d -i build-pipeline.yaml "spec.tasks.(name==build-image)"
yq m -i -a build-pipeline.yaml - <<EOF
spec:
tasks:
- name: build-image
taskRef:
name: buildpacks-v3
runAfter:
- fetch-repository
- lint
- test
workspaces:
- name: source
workspace: shared-workspace
params:
- name: BUILDER_IMAGE
value: gcr.io/paketo-buildpacks/builder:base-platform-api-0.3
- name: CACHE
value: buildpacks-cache
resources:
outputs:
- name: image
resource: build-image
EOF
yq d -i build-pipeline.yaml - <<EOF
spec:
params:
- name: image
description: reference of the image to build
EOF
yq m -i build-pipeline.yaml - <<EOF
spec:
resources:
- name: build-image
type: image
EOF
cat <<EOF >buildpacks-cache-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
name: buildpacks-cache-pv
spec:
capacity:
storage: 3Gi
volumeMode: Filesystem
accessModes:
- ReadWriteOnce
persistentVolumeReclaimPolicy: Delete
storageClassName: local-storage
hostPath:
path: "/mnt/data"
EOF
cat <<EOF >>buildpacks-cache-pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: buildpacks-cache-pvc
spec:
storageClassName: local-storage
accessModes:
- ReadWriteOnce
resources:
requests:
storage: 500Mi
EOF
yq d -i build-trigger-template.yaml 'spec.resourcetemplates[0].spec.params.(name==image)'

yq m -i build-trigger-template.yaml - <<EOF
spec:
resourcetemplates:
- spec:
resources:
- name: build-image
resourceRef:
name: buildpacks-app-image
podTemplate:
volumes:
- name: buildpacks-cache
persistentVolumeClaim:
claimName: buildpacks-cache-pvc
EOF
cat <<EOF >buildpacks-app-image.yaml
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
name: buildpacks-app-image
spec:
type: image
params:
- name: url
value: ${IMG_NS}/go-sample-app:1.0.3
EOF
# Install Tekton CRDs
kubectl apply -f https://storage.googleapis.com/tekton-releases/pipeline/previous/v0.13.2/release.yaml
kubectl apply -f https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml

# Install Tasks to clone app repo, lint and test the Go app
kubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/v1beta1/git/git-clone.yaml
kubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/v1beta1/golang/lint.yaml
kubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/v1beta1/golang/tests.yaml
#kubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/v1beta1/kaniko/kaniko.yaml

# Install new buildpacks Task to build image
kubectl apply -f https://raw.githubusercontent.com/tektoncd/catalog/v1beta1/buildpacks/buildpacks-v3.yaml
tkn task list
tkn pipeline list
kubectl create secret generic regcred  --from-file=.dockerconfigjson=/root/.docker/config.json --type=kubernetes.io/dockerconfigjson
kubectl apply -f sa.yaml               -f pv.yaml               -f pvc.yaml               -f buildpacks-cache-pv.yaml               -f buildpacks-cache-pvc.yaml               -f buildpacks-app-image.yaml
kubectl apply -f build-pipeline.yaml               -f build-trigger-template.yaml               -f build-trigger-binding.yaml               -f build-event-listener.yaml
kubectl rollout status deployment/el-build-event-listener
kubectl port-forward --address 0.0.0.0 svc/el-build-event-listener 8080:8080 2>&1 > /dev/null &
curl     -H 'X-GitHub-Event: pull_request'     -H 'Content-Type: application/json'     -d '{
"repository": {"clone_url": "'"https://github.com/${IMG_NS}/go-sample-app"'"},
"pull_request": {"head": {"sha": "master"}}
}' localhost:8080
tkn pipelinerun list
tkn pipelinerun logs -f
pkill kubectl && wait $!
kubectl apply -f https://github.com/pivotal/kpack/releases/download/v0.0.9/release-0.0.9.yaml
kubectl get all -n kpack
kubectl api-resources --api-group build.pivotal.io
kubectl get builders,builds,clusterbuilders,images,sourceresolvers --all-namespaces
mkdir -p /workspace/go-sample-app-ops/cicd/kpack
cd /workspace/go-sample-app-ops/cicd/kpack
cat <<EOF >builder.yaml
apiVersion: build.pivotal.io/v1alpha1
kind: Builder
metadata:
name: paketo-builder
spec:
image: gcr.io/paketo-buildpacks/builder:base
EOF
cat <<EOF >image.yaml
apiVersion: build.pivotal.io/v1alpha1
kind: Image
metadata:
name: go-sample-app
spec:
builder:
name: paketo-builder
kind: Builder
serviceAccount: build-bot
#cacheSize: "1.5Gi"
source:
git:
url: https://github.com/$GITHUB_NS/go-sample-app
revision: master
tag: $IMG_NS/go-sample-app:kpack-1.0.0
EOF
kubectl apply -f builder.yaml               -f image.yaml
kubectl get builds
kubectl describe build go-sample-app-build-1-<uuid>
kubectl get pods
logs -image go-sample-app -build 1
cd ../tekton
cat <<EOF >update-image-revision-task.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
name: update-image-revision
spec:
workspaces:
- name: source
params:
- name: GITHUB_TOKEN_SECRET
type: string
description: Name of the secret holding the github-token.
default: github-token
- name: GITHUB_TOKEN_SECRET_KEY
type: string
description: Name of the secret key holding the github-token.
default: GITHUB_TOKEN
- name: REVISION
type: string
description: The source code repository's Git revision to build with kpack.
EOF
cat <<EOF >>update-image-revision-task.yaml
steps:
- name: update-revision
image: mikefarah/yq
workingDir: $(workspaces.source.path)
script: |
cd cicd/kpack
yq w -i image.yaml "spec.source.git.revision" "$(params.REVISION)"
EOF
cat <<EOF >>update-image-revision-task.yaml
- name: git-commit
image: gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.12.1
workingDir: $(workspaces.source.path)
script: |
apk add tree
tree
git remote set-url origin https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/${GITHUB_NS}/go-sample-app-ops.git
git config user.name build-bot
git config user.email build-bot@bots.bot
git checkout -b temp-branch
git add cicd/kpack/image.yaml
git commit -m "Setting revision to current source code repo commit to trigger kpack"
git checkout master
git merge temp-branch
git push origin master
env:
- name: GITHUB_TOKEN
valueFrom:
secretKeyRef:
name: $(params.GITHUB_TOKEN_SECRET)
key: $(params.GITHUB_TOKEN_SECRET_KEY)
EOF
yq r -C update-image-revision-task.yaml
kubectl apply -f update-image-revision-task.yaml
yq d -i build-pipeline.yaml "spec.tasks.(name==build-image)"
yq d -i build-pipeline.yaml "spec.resources"
yq m -i -a build-pipeline.yaml - <<EOF
spec:
tasks:
- name: fetch-ops-repository
runAfter:
- fetch-repository
- lint
- test
taskRef:
name: git-clone
workspaces:
- name: output
workspace: shared-ops-workspace
params:
- name: url
value: https://github.com/${GITHUB_NS}/go-sample-app-ops.git
- name: revision
value: master
- name: deleteExisting
value: "true"
EOF
yq m -i -a build-pipeline.yaml - <<EOF
spec:
workspaces:
- name: shared-ops-workspace
description: This workspace will receive the cloned Git ops repo and be passed to the next Task.
EOF
yq m -i -a build-pipeline.yaml - <<EOF
spec:
tasks:
- name: update-image-revision
taskRef:
name: update-image-revision
runAfter:
- fetch-repository
- lint
- test
- fetch-ops-repository
workspaces:
- name: source
workspace: shared-ops-workspace
params:
- name: GITHUB_TOKEN_SECRET
value: $(params.github-token-secret)
- name: GITHUB_TOKEN_SECRET_KEY
value: $(params.github-token-secret-key)
- name: REVISION
value: $(params.revision)
EOF
yq m -i -a build-pipeline.yaml - <<EOF
spec:
params:
- name: github-token-secret
type: string
description: Name of the secret holding the github-token.
- name: github-token-secret-key
description: Name of the secret key holding the github-token.
EOF
yq d -i build-pipeline.yaml "spec.params.(name==image)"
yq r -C build-pipeline.yaml
yq d -i build-trigger-template.yaml "spec.resourcetemplates[0].spec.params"
yq m -i build-trigger-template.yaml - <<EOF
spec:
resourcetemplates:
- spec:
params:
- name: repo-url
value: $(params.REPO_URL)
- name: revision
value: $(params.REVISION)
- name: github-token-secret
value: github-token
- name: github-token-secret-key
value: GITHUB_TOKEN
EOF
yq m -i build-trigger-template.yaml - <<EOF
spec:
resourcetemplates:
- spec:
workspaces:
- name: shared-workspace
persistentvolumeclaim:
claimName: workspace-pvc
- name: shared-ops-workspace
persistentvolumeclaim:
claimName: workspace-pvc
EOF
yq d -i build-trigger-template.yaml "spec.params.(name==IMAGE)"
yq r -C build-trigger-template.yaml
yq d -i build-trigger-template.yaml "spec.params.(name==IMAGE)"
kubectl apply -f .
cd ../kpack
yq m -i builder.yaml - <<EOF
spec:
updatePolicy: external
EOF
kubectl apply -f builder.yaml
cd ../argo
cat <<EOF >argo-deploy-image.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
name: go-sample-app-image
spec:
destination:
namespace: default
server: https://kubernetes.default.svc
project: default
source:
path: cicd/kpack
repoURL: https://github.com/${GITHUB_NS}/go-sample-app-ops.git
targetRevision: HEAD
syncPolicy:
automated: {}
EOF
cat <<EOF >argo-deploy-tekton.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
name: tekton
spec:
destination:
namespace: default
server: https://kubernetes.default.svc
project: default
source:
path: cicd/tekton
repoURL: https://github.com/${GITHUB_NS}/go-sample-app-ops.git
targetRevision: HEAD
syncPolicy:
automated: {}
EOF
git add -A
git commit -m 'Changes from the Buildpacks scenario'
git push origin master
kubectl create ns dev
kubectl create ns prod
kubectl create ns argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

kubectl apply -f . -n argocd
yq m <(kubectl get cm argocd-cm -o yaml -n argocd) <(cat << EOF
data:
kustomize.buildOptions: --load_restrictor none
EOF
) | kubectl apply -f -
cd ../tekton
kubectl apply -f .
cd /workspace/go-sample-app
sed -i 's/sunshine/pipeline/g' hello-server.go
git add hello-server.go
git commit -m "Hello pipeline!"
git push
SHA=$(git rev-parse origin/master)
kubectl rollout status deployment/el-build-event-listener
kubectl rollout status deployment/el-ops-dev-event-listener
kubectl port-forward --address 0.0.0.0 svc/el-build-event-listener 8081:8080 2>&1 > /dev/null &
curl     -H 'X-GitHub-Event: pull_request'     -H 'Content-Type: application/json'     -d '{
"repository": {"clone_url": "'"https://github.com/${IMG_NS}/go-sample-app"'"},
"pull_request": {"head": {"sha": "'"${SHA}"'"}}
}' localhost:8081
tkn pipelinerun list
tkn pipelinerun logs -f
kubectl get builds
kubectl describe build $(kubectl get builds -o yaml | yq r - "items[-1].metadata.name")
kubectl describe build $(kubectl get builds -o yaml | yq r - "items[-1].metadata.name") | grep Revision
BUILD_NR=$(kubectl get builds -o yaml | yq r - "items[-1].metadata.labels.[image.build.pivotal.io/buildNumber]")
logs -image go-sample-app -build $BUILD_NR
kubectl port-forward --address 0.0.0.0 svc/el-ops-dev-event-listener 8082:8080 2>&1 > /dev/null &
TAG=$(logs -image go-sample-app -build $BUILD_NR | grep kpack- | grep index.docker.io | cut -d ":" -f2)
echo $TAG
curl    -H 'Content-Type: application/json'    -d '{
"push_data": {
"tag": "'"${TAG}"'"
}
}' localhost:8082
tkn pipelinerun list
tkn pipelinerun logs -f
kubectl get deploy -n dev

kubectl rollout status deployment/dev-go-sample-app -n dev
kubectl port-forward service/dev-go-sample-app 8083:8080 -n dev 2>&1 > /dev/null &
curl localhost:8083
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
kubectl port-forward --address 0.0.0.0 svc/argocd-server 8080:80 -n argocd 2>&1 > /dev/null &
