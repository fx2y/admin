@_ECHO_OFF

# Setup namespaces
#kubectl delete ns dev; kubectl delete ns prod
#kubectl create ns dev; kubectl create ns prod

rm -rf cd go-sample-app
git clone https://github.com/springone-tour-2020-cicd/go-sample-app.git && cd go-sample-app

# Check which process is on port 8080:
#lsof -i :8080 | grep LISTEN

clear
@_ECHO_ON

@_ECHO_# Sample app
# Initial build

ls
go run hello-server.go 2>&1 > /dev/null &
curl localhost:8080
pkill hello-server && wait $!

environment=sandbox; go run hello-server.go

@_ECHO_# Build with Dockerfile

docker build . -t go-sample-app
docker images | grep go-sample-app

docker tag go-sample-app $IMG_NS/go-sample-app:1.0.0
docker push $IMG_NS/go-sample-app:1.0.0

# Initial deploy

mkdir ops
kubectl create deployment go-sample-app --image=$IMG_NS/go-sample-app:1.0.0 -n dev --dry-run=client -o yaml > ops/deployment.yaml
k create service clusterip go-sample-app --tcp=8080:8080 -n dev --dry-run=client -o yaml > ops/service.yaml
bat ops/deployment.yaml
bat ops/service.yaml
k apply -f ops
k rollout status deployment/go-sample-app -n dev
k get all -n dev
k port-forward service/go-sample-app 8080:8080 -n dev 2>&1 > /dev/null &
curl localhost:8080
pkill kubectl && wait $!

@_ECHO_# Rebuild

@_SKIPsed -i 's/world!/sunshine!/g' hello-server.go
sed -i '' 's/world/sunshine/g' hello-server.go
docker build . -t go-sample-app -t $IMG_NS/go-sample-app:1.0.1
docker push $IMG_NS/go-sample-app:1.0.1
@_SKIPsed -i 's|1.0.0|1.0.1|g' ops/deployment.yaml
sed -i '' 's|1.0.0|1.0.1|g' ops/deployment.yaml
k apply -f ops
k rollout status deployment/go-sample-app -n dev
k port-forward service/go-sample-app 8080:8080 -n dev 2>&1 > /dev/null &
curl localhost:8080
pkill kubectl && wait $!

@_ECHO_# Promote to prod

cp -r $DEMO/intro/ops .
tree .
cd ops
bat deployment.yaml
bat service.yaml
cp deployment.yaml deployment-prod.yaml
cp service.yaml service-prod.yaml
yq w -i deployment-prod.yaml "metadata.namespace" "prod"
yq w -i service-prod.yaml "metadata.namespace" "prod"
k apply -f deployment-prod.yaml
k apply -f service-prod.yaml
k rollout status deployment/go-sample-app -n prod
k port-forward service/go-sample-app 8080:8080 -n prod 2>&1 > /dev/null &
curl localhost:8080
pkill kubectl && wait $!
cd ..

@_ECHO_# Save work

hub fork --remote-name origin
git add -A
git commit -m 'Changes from the Intro Scenario'
git push origin master
